<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>试卷分析系统</title>
  <style>
    h1, h2 { font-weight: normal; }
    #msg { margin-top: 10px; color: #666; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #result { white-space: pre-wrap; padding: 15px; border: 1px solid #eee; }
    .history-item { margin: 10px 0; padding: 8px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>试卷分析系统</h1>
  
  <!-- 多文件上传 -->
  <input id="fileSelector" type="file" multiple />
  <button id="submitBtn">上传图片</button>
  <button id="analyzeBtn" disabled>开始分析</button>
  <button id="historyBtn">查看记录</button>
  <div id="msg"></div>
  <div id="result"></div>
  <div id="history"></div>

  <script>
    (function () {
      const API_ENDPOINT = 'https://analyze-4gbej3877844ea2d-1343742632.ap-shanghai.app.tcloudbase.com';
      let uploadedUrls = [];
      const userId = localStorage.getItem('user_id') || Date.now().toString(36) + Math.random().toString(36).substr(2);
      localStorage.setItem('user_id', userId);

      // --- 原始COS直传逻辑（修改后）---
      const camSafeUrlEncode = function (str) {
        return encodeURIComponent(str)
          .replace(/!/g, '%21')
          .replace(/'/g, '%27')
          .replace(/\(/g, '%28')
          .replace(/\)/g, '%29')
          .replace(/\*/g, '%2A');
      };

      const getAuthorization = function (opt, callback) {
        const url = `${API_ENDPOINT}/shangchuan?ext=${opt.ext}`;
        const xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onload = function (e) {
          try {
            const result = JSON.parse(e.target.responseText);
            const credentials = result.data;
            callback(null, {
              securityToken: credentials.sessionToken,
              authorization: credentials.authorization,
              cosKey: credentials.cosKey,
              cosHost: credentials.cosHost,
            });
          } catch (e) {
            callback('获取签名失败');
          }
        };
        xhr.onerror = () => callback('网络错误');
        xhr.send();
      };

      const uploadFile = function (file, callback) {
        const fileName = file.name;
        let ext = '';
        const lastDotIndex = fileName.lastIndexOf('.');
        if (lastDotIndex > -1) ext = fileName.substring(lastDotIndex + 1);
        
        getAuthorization({ ext }, function (err, info) {
          if (err) return callback(err);
          const url = `${info.cosHost}/${camSafeUrlEncode(info.cosKey).replace(/%2F/g, '/')}`;
          const xhr = new XMLHttpRequest();
          xhr.open('PUT', `https://${url}`, true);
          xhr.setRequestHeader('Authorization', info.authorization);
          xhr.setRequestHeader('X-User-Id', userId);
          xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
              callback(null, { url: `https://${url}` });
            } else {
              callback(`上传失败（${xhr.status}）`);
            }
          };
          xhr.send(file);
        });
      };

      // --- 上传按钮逻辑 ---
      document.getElementById('submitBtn').onclick = async function () {
        const files = [...document.getElementById('fileSelector').files];
        if (files.length === 0) {
          document.getElementById('msg').innerText = '未选择文件';
          return;
        }

        uploadedUrls = [];
        document.getElementById('msg').innerText = '上传中...';
        
        const uploadPromises = files.map(file => 
          new Promise(resolve => {
            uploadFile(file, (err, data) => {
              if (!err && data) uploadedUrls.push(data.url);
              resolve();
            });
          })
        );

        await Promise.all(uploadPromises);
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('msg').innerText = `已上传 ${uploadedUrls.length} 张图片`;
      };

      // --- 分析按钮逻辑 ---
      document.getElementById('analyzeBtn').onclick = async function () {
        document.getElementById('msg').innerText = '分析中...';
        try {
          const response = await fetch(`${API_ENDPOINT}/fenxi`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Id': userId
            },
            body: JSON.stringify({ imageUrls: uploadedUrls })
          });
          const result = await response.json();
          
          if (result.error) throw new Error(result.error);
          document.getElementById('result').innerHTML = result.result.replace(/<br>/g, '\n');
          document.getElementById('msg').innerText = '分析完成';

          // 添加PDF下载链接
          if (result.pdfUrl) {
            const downloadLink = `<a href="${result.pdfUrl}" download style="color: blue;">下载PDF试卷</a>`;
            document.getElementById('result').innerHTML += '\n\n' + downloadLink;
          }
        } catch (e) {
          document.getElementById('msg').innerText = '分析失败: ' + e.message;
        }
      };

      // --- 历史记录逻辑 ---
      document.getElementById('historyBtn').onclick = async function () {
        document.getElementById('history').innerHTML = '加载中...';
        try {
          const response = await fetch(`${API_ENDPOINT}/history?userId=${userId}`);
          const { data } = await response.json();
          
          const html = data.map(item => `
            <div class="history-item">
              <div>时间：${new Date(item.time).toLocaleString()}</div>
              <a href="${item.pdfUrl}" download>下载试卷</a>
            </div>
          `).join('');
          
          document.getElementById('history').innerHTML = html || '无24小时内记录';
        } catch (e) {
          document.getElementById('history').innerHTML = '加载失败';
        }
      };
    })();
  </script>
</body>
</html>