<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ajax Put 上传（服务端计算签名）</title>
    <style>
      h1,
      h2 {
        font-weight: normal;
      }

      #msg {
        margin-top: 10px;
        color: #666;
      }
      #submitBtn {
        margin-left: 10px;
        padding: 4px 12px;
      }
    </style>
  </head>
  <body>
    <h1>Ajax Put 上传（服务端计算签名）</h1>

    <input id="fileSelector" type="file" />
    <button id="submitBtn">开始上传</button>

    <div id="msg"></div>

    <script>
      (function () {
        // 对更多字符编码的 url encode 格式
        const camSafeUrlEncode = function (str) {
          return encodeURIComponent(str)
            .replace(/!/g, "%21")
            .replace(/'/g, "%27")
            .replace(/\(/g, "%28")
            .replace(/\)/g, "%29")
            .replace(/\*/g, "%2A");
        };

        // 计算签名
        const getAuthorization = function (opt, callback) {
          // 替换为您的云函数地址
          const url = `https://analyze-4gbej3877844ea2d-1343742632.ap-shanghai.app.tcloudbase.com/shangchuan?ext=${opt.ext}`;
          
          const xhr = new XMLHttpRequest();
          xhr.open("GET", url, true);
          xhr.onload = function (e) {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const credentials = JSON.parse(xhr.responseText);
                callback(null, {
                  securityToken: credentials.sessionToken,
                  authorization: credentials.authorization,
                  cosKey: credentials.cosKey,
                  cosHost: credentials.cosHost,
                });
              } catch (e) {
                callback("解析签名信息失败");
              }
            } else {
              callback(`获取签名失败，状态码：${xhr.status}`);
            }
          };
          xhr.onerror = function () {
            callback("网络错误，无法连接签名服务");
          };
          xhr.send();
        };

        // 上传文件
        const uploadFile = function (file, callback) {
          const fileName = file.name;
          let ext = fileName.slice((fileName.lastIndexOf(".") - 1 >>> 0) + 2);
          
          getAuthorization({ ext }, function (err, info) {
            if (err) {
              callback(err);
              return;
            }

            const Key = info.cosKey;
            const url = `https://${info.cosHost}/${camSafeUrlEncode(Key).replace(/%2F/g, "/")}`;
            
            const xhr = new XMLHttpRequest();
            xhr.open("PUT", url, true);
            xhr.setRequestHeader("Authorization", info.authorization);
            if (info.securityToken) {
              xhr.setRequestHeader("x-cos-security-token", info.securityToken);
            }

            xhr.upload.onprogress = function (e) {
              if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                document.getElementById("msg").innerText = `上传中：${percent}%`;
              }
            };

            xhr.onload = function () {
              if (xhr.status >= 200 && xhr.status < 300) {
                callback(null, {
                  url: url,
                  ETag: xhr.getResponseHeader("etag")
                });
              } else {
                callback(`上传失败，状态码：${xhr.status}`);
              }
            };

            xhr.onerror = function () {
              callback("网络错误，上传失败");
            };

            xhr.send(file);
          });
        };

        // 绑定上传事件
        document.getElementById("submitBtn").addEventListener("click", function () {
          const fileInput = document.getElementById("fileSelector");
          const file = fileInput.files[0];
          const msgDiv = document.getElementById("msg");

          if (!file) {
            msgDiv.innerText = "请先选择文件";
            msgDiv.style.color = "red";
            return;
          }

          msgDiv.style.color = "#666";
          msgDiv.innerText = "开始上传...";

          uploadFile(file, function (err, data) {
            if (err) {
              msgDiv.style.color = "red";
              msgDiv.innerText = "上传失败：" + err;
              console.error(err);
            } else {
              msgDiv.style.color = "green";
              msgDiv.innerText = `上传成功！访问地址：${data.url}`;
              console.log("ETag:", data.ETag);
            }
          });
        });
      })();
    </script>
  </body>
</html>
