<!DOCTYPE html>
<html>
<head>
    <title>上传图片到腾讯云</title>
    <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
</head>
<body>
    <input type="file" id="fileInput" accept="image/*">
    <button onclick="upload()">上传</button>

    <script>
        // 配置参数（需自行修改部分）
        const bucket = 'shijuanshibie-1343742632'; // 格式必须是 BucketName-APPID
        const region = 'ap-beijing';          // 北京地域
        const cloudFunctionUrl = 'https://analyze-4gbej3877844ea2d-1343742632.ap-shanghai.app.tcloudbase.com/shangchuan'; // 替换为你的云函数URL

        // 获取临时密钥
        async function getTempKey() {
            const res = await fetch(cloudFunctionUrl, { method: 'POST' });
            return res.json();
        }

        // 上传逻辑
        async function upload() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert('请选择文件');

            try {
                const tempKey = await getTempKey();
                
                const cos = new COS({
                    getAuthorization: (options, callback) => {
                        callback({
                            TmpSecretId: tempKey.tmpSecretId,
                            TmpSecretKey: tempKey.tmpSecretKey,
                            XCosSecurityToken: tempKey.sessionToken, // 关键参数
                            StartTime: tempKey.startTime,
                            ExpiredTime: tempKey.expiredTime
                        });
                    }
                });

                cos.putObject({
                    Bucket: bucket,
                    Region: region,
                    Key: 'images/' + file.name,
                    Body: file,
                }, (err, data) => {
                    if (err) {
                        console.error('上传失败:', err);
                        alert('上传失败，请检查控制台日志');
                    } else {
                        alert('上传成功！URL: ' + data.Location);
                    }
                });
            } catch (err) {
                alert('获取密钥失败: ' + err.message);
            }
        }
    </script>
</body>
</html>
