<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>文件分块上传</title>
  <style>
    .progress { width: 300px; height: 20px; border: 1px solid #ccc; }
    .progress-bar { height: 100%; background: #4CAF50; transition: width 0.3s; }
  </style>
</head>
<body>
  <input type="file" id="fileInput">
  <button onclick="upload()">开始上传</button>
  <div class="progress">
    <div class="progress-bar" style="width: 0%"></div>
  </div>

  <script>
    const CHUNK_SIZE = 2 * 1024 * 1024; // 2MB
    const API_URL = 'https://analyze-4gbej3877844ea2d-1343742632.ap-shanghai.app.tcloudbase.com/shangchuan';

    async function upload() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return;

      const fileId = Math.random().toString(36).slice(2); // 生成唯一ID
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
      const etags = [];
      let uploadId = null;

      try {
        // 初始化上传
        const initRes = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            action: 'init',
            fileId,
            fileName: file.name
          })
        });
        const initData = await initRes.json();
        uploadId = initData.data.uploadId;

        // 分块上传
        for (let i = 0; i < totalChunks; i++) {
          const chunk = file.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
          const formData = new FormData();
          formData.append('chunk', chunk);
          formData.append('chunkIndex', i);
          formData.append('fileId', uploadId);
          formData.append('fileName', file.name);

          const uploadRes = await fetch(API_URL, { 
            method: 'POST',
            body: formData 
          });
          const uploadData = await uploadRes.json();
          etags[i] = uploadData.data.etag;

          updateProgress(((i + 1) / totalChunks) * 100);
        }

        // 完成上传
        await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            action: 'complete',
            fileId: uploadId,
            fileName: file.name,
            parts: etags
          })
        });

        alert('上传成功！');
      } catch (error) {
        alert('上传失败: ' + error.message);
      }
    }

    function updateProgress(percent) {
      document.querySelector('.progress-bar').style.width = percent + '%';
    }
  </script>
</body>
</html>
