<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>文件上传演示</title>
    <style>
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; }
        #progress { height: 20px; background: #f0f0f0; margin: 10px 0; }
        #progressBar { width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s; }
        #status { color: #666; margin-top: 10px; }
        .error { color: #ff4444; }
        .success { color: #00C851; }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-box">
            <input type="file" id="fileInput">
            <button onclick="startUpload()">开始上传</button>
            <div id="progress"><div id="progressBar"></div></div>
            <div id="status">准备就绪</div>
        </div>
    </div>

    <script>
        // 安全URL编码
        const safeEncode = str => encodeURIComponent(str)
            .replace(/!/g, '%21')
            .replace(/'/g, '%27')
            .replace(/\(/g, '%28')
            .replace(/\)/g, '%29')
            .replace(/\*/g, '%2A');

        // 更新状态显示
        function updateStatus(text, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.className = isError ? 'error' : 'success';
            statusEl.textContent = text;
        }

        // 获取上传签名
        async function getUploadSignature(ext) {
            try {
                const response = await fetch(
                    `https://analyze-4gbej3877844ea2d-1343742632.ap-shanghai.app.tcloudbase.com/shangchuan?ext=${ext}`
                );
                
                if (!response.ok) throw new Error(`HTTP错误 ${response.status}`);
                const data = await response.json();
                
                // 调试输出
                console.log('签名响应:', data);
                
                if (!data.cosHost || !data.cosKey) {
                    throw new Error('无效的服务器响应');
                }
                
                return data;
            } catch (error) {
                console.error('获取签名失败:', error);
                throw new Error(`无法获取上传凭证: ${error.message}`);
            }
        }

        // 执行文件上传
        async function uploadFile(file, cosHost, cosKey, auth) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const url = `https://${cosHost}/${safeEncode(cosKey).replace(/%2F/g, '/')}`;

                xhr.open('PUT', url, true);
                xhr.setRequestHeader('Authorization', auth);
                
                xhr.upload.onprogress = e => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('progressBar').style.width = `${percent}%`;
                    }
                };

                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.getResponseHeader('etag'));
                    } else {
                        reject(`上传失败: ${xhr.status} ${xhr.statusText}`);
                    }
                };

                xhr.onerror = () => reject('网络错误，请检查连接');
                xhr.send(file);
            });
        }

        // 开始上传流程
        async function startUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                updateStatus('请先选择文件', true);
                return;
            }

            try {
                updateStatus('正在获取上传凭证...');
                
                // 获取文件扩展名
                const ext = file.name.split('.').pop().toLowerCase();
                const { cosHost, cosKey, authorization } = await getUploadSignature(ext);
                
                updateStatus('开始上传...');
                const etag = await uploadFile(file, cosHost, cosKey, authorization);
                
                updateStatus(`上传成功！ETag: ${etag}`);
            } catch (error) {
                console.error('上传失败:', error);
                updateStatus(error.message, true);
            }
        }
    </script>
</body>
</html>
