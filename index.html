
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>文件分块上传</title>
  <style>
    .progress { width: 300px; height: 20px; border: 1px solid #ccc; }
    .progress-bar { height: 100%; background: #4CAF50; transition: width 0.3s; }
  </style>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<body>
  <input type="file" id="fileInput" />
  <button onclick="upload()">开始上传</button>
  <div class="progress">
    <div class="progress-bar" style="width: 0%"></div>
  </div>

  <script>
    const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB
    const API_URL = 'https://analyze-4gbej3877844ea2d-1343742632.ap-shanghai.app.tcloudbase.com/shangchuan';

    async function upload() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return;

      const fileId = CryptoJS.MD5(file.name + Date.now()).toString();
      const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
      let uploaded = 0;

      // 初始化分块上传
      await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'init',
          fileId,
          fileName: file.name,
          totalChunks
        })
      });

      // 上传所有分块
      for (let i = 0; i < totalChunks; i++) {
        const chunk = await readChunk(file, i);
        await uploadChunk(chunk, i, fileId, file.name);
        uploaded++;
        updateProgress((uploaded / totalChunks) * 100);
      }

      // 合并分块
      const res = await fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'complete',
          fileId,
          fileName: file.name
        })
      });
      
      alert('上传完成');
    }

    function readChunk(file, index) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        const start = index * CHUNK_SIZE;
        const end = Math.min(start + CHUNK_SIZE, file.size);
        
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file.slice(start, end));
      });
    }

    async function uploadChunk(chunk, index, fileId, fileName) {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          chunk: chunk.split(',')[1], // 移除base64前缀
          chunkIndex: index,
          fileId,
          fileName
        })
      });
      return response.json();
    }

    function updateProgress(percent) {
      document.querySelector('.progress-bar').style.width = percent + '%';
    }
  </script>
</body>
</html>
  
