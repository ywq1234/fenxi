<!DOCTYPE html>
<html>
<head>
  <title>前端直传文件到腾讯云 COS</title>
  <!-- 引入 COS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js"></script>
</head>
<body>
  <input type="file" id="file-input" />
  <button onclick="uploadFile()">上传</button>
  <div id="progress"></div>

  <script>
    // 配置参数（替换为你自己的信息）
    const cosConfig = {
      Bucket: 'shijuanshibie-1343742632',      // 存储桶名称
      Region: 'ap-beijing',              // 存储桶地域
      UploadPath: 'uploads/',              // 文件存储路径
      ServerURL: 'https://analyze-4gbej3877844ea2d-1343742632.ap-shanghai.app.tcloudbase.com/shangchuan' // 云函数地址（用于获取临时密钥）
    };

    // 初始化 COS 实例
    const cos = new COS({
      getAuthorization: async (options, callback) => {
        try {
          // 调用云函数获取临时密钥
          const res = await fetch(cosConfig.ServerURL);
          const data = await res.json();
          callback({
            TmpSecretId: data.credentials.tmpSecretId,
            TmpSecretKey: data.credentials.tmpSecretKey,
            SecurityToken: data.credentials.sessionToken,
            StartTime: data.startTime,
            ExpiredTime: data.expiredTime,
          });
        } catch (err) {
          console.error('获取临时密钥失败:', err);
        }
      }
    });

    // 上传文件
    async function uploadFile() {
      const file = document.getElementById('file-input').files[0];
      if (!file) return alert('请选择文件');

      // 生成唯一文件名（避免覆盖）
      const fileName = `${cosConfig.UploadPath}${Date.now()}_${file.name}`;

      // 分片上传（自动处理大文件）
      cos.uploadFile({
        Bucket: cosConfig.Bucket,
        Region: cosConfig.Region,
        Key: fileName,
        Body: file,
        SliceSize: 5 * 1024 * 1024, // 分片大小 5MB（腾讯云支持最小 1MB）
        onProgress: (progressData) => {
          document.getElementById('progress').innerHTML = 
            `上传进度: ${Math.round(progressData.percent * 100)}%`;
        },
      }, (err, data) => {
        if (err) {
          console.error('上传失败:', err);
          alert('上传失败，请检查控制台');
        } else {
          console.log('上传成功:', data.Location);
          alert(`文件地址: ${data.Location}`);
        }
      });
    }
  </script>
</body>
</html>
